/*! sassyjson - v0.0.2 - 2014-01-17 */
// Logs an error at `$pointer` with `$string` message
// @param $string: error message
// @param $position: pointer position
@function _throw($string, $pointer) {
  @warn "ERROR::#{$pointer}::#{$string}";
  @return $pointer, false;
}

// Move pointer to `$token`
@function _consume($source, $pointer, $token) { 
  $length: str-length($source);
  @while $pointer <= $length {
    $char: str-slice($source, $pointer, $pointer);
    $pointer: $pointer + 1;
  
    @if $char == $token {
      @return $pointer;
    }
    
    @else if $char == " " {
      // @continue;
    }
    
    @else {
      @return _throw("Expected `" + $token + "` found `" + $char + "`.", $pointer);
    }
  }

  @return _throw("Expected `" + $token + "` but reached end of stream.", $pointer);
}
// JSON.parse value
@function _json-decode--value($source, $pointer) {
  $length: str-length($source);

  @while $pointer <= $length {
    $char: str-slice($source, $pointer, $pointer);
    $pointer: $pointer + 1;

    @if $char == '{' {
      @return _json-decode--map($source, $pointer);
    }
    @else if $char == '[' {
      @return _json-decode--list($source, $pointer);
    }
    @else if $char == 't' {
      @return _json-decode--true($source, $pointer);
    }
    @else if $char == 'f' {
      @return _json-decode--false($source, $pointer);
    }
    @else if $char == '"' {
      @return _json-decode--string($source, $pointer);
    }
    @else if $char == 'n' {
      @return _json-decode--null($source, $pointer);
    }
    @else if index('1' '2' '3' '4' '5' '6' '7' '8' '9' '0' '-' '.', $char) {
      @return _json-decode--number($source, $pointer);
    }
    @else if $char == ' ' {
      // @continue;
    }
    @else {
      @return _throw("Unexpected token `" + $char + "`.", $pointer);
    }
  }

  @return _throw("Empty JSON string.", $pointer);
}

@function _pow($x, $n) {
  $ret: 1;

  @if $n >= 0 {
    @for $i from 1 through $n {
      $ret: $ret * $x;
    }
  } @else {
    @for $i from $n to 0 {
      $ret: $ret / $x;
    }
  }

  @return $ret;
}

// Strip special carriage return char
// @param $string: string to parse
// @param $char: char to strip
// @return [string]
@function _strip-special-char($string, $char) {
  $cr: "
  "; // Carriage return
  
  @while str-index($string, $char) and str-index($string, $char) > 0 {
    $index: str-index($string, $char);
    $string: str-slice($string, 1, $index - 1) + $cr + str-slice($string, $index + str-length($char));
  }
  
  @return $string;
}
@function _find-integer($source, $pointer) {
  $length: str-length($source);
  $strings: '0' '1' '2' '3' '4' '5' '6' '7' '8' '9';
  $numbers:  0   1   2   3   4   5   6   7   8   9;
  $result: 0;

  @while $pointer <= $length {
    $char: to-lower-case(str-slice($source, $pointer, $pointer));
    $index: index($strings, $char);

    @if $char == '-' {
      // do nothing
    }
    @else if $index {
      $number: nth($numbers, $index);
      $result: $result * 10 + $number;
    }
    @else {
      @if index('e' '.' ',' ']' '}' ' ', $char) {
        @return $pointer, $result;
      }
      @return _throw("Unexpected character `" + $char + "`.", $pointer);
    }

    $pointer: $pointer + 1;
  }

  @return $pointer, $result;
}

@function _find-digits($source, $pointer) {
  $length: str-length($source);
  $strings: '0' '1' '2' '3' '4' '5' '6' '7' '8' '9';
  $numbers:  0   1   2   3   4   5   6   7   8   9;
  $result: null;
  $runs: 1;

  @while $pointer <= $length {
    $char: to-lower-case(str-slice($source, $pointer, $pointer));
    $index: index($strings, $char);

    @if $char == '.' {
      // @continue;
    }
    @else if $index and $index > 0 {
      $number: nth($numbers, $index);
      $runs: $runs * 10;
      $result: if($result == null, $number, $result * 10 + $number);
    }
    @else {
      @if index('e' '.' ',' ']' '}' ' ', $char) {
        @return $pointer, if($result != null, $result / $runs, $result);
      }
      @return _throw("Unexpected character `" + $char + "`.", $pointer);
    }

    $pointer: $pointer + 1;
  }

  @return $pointer, if($result != null, $result / $runs, $result);
}

@function _find-exponent($source, $pointer) {
  $length: str-length($source);
  $strings: '0' '1' '2' '3' '4' '5' '6' '7' '8' '9';
  $numbers:  0   1   2   3   4   5   6   7   8   9;
  $result: null;
  $minus: false;

  @while $pointer <= $length {
    $char: to-lower-case(str-slice($source, $pointer, $pointer));
    $index: index($strings, $char);

    @if $char == 'e' {
      // @continue;
    }
    @else if $char == '-' {
      $minus: true;
    }
    @else if $char == '+' {
      $minus: false;
    }
    @else if $index and $index > 0 {
      $number: nth($numbers, $index);
      $result: if($result == null, $number, $result * 10 + $number);
    }
    @else {
      @if not index(" ", ", ", "]", "}", $char) {
        @return _throw("Unexpected character `" + $char + "`.", $pointer);
      }

      @return $pointer, if($minus and $result != null, $result * -1, $result);
    }

    $pointer: $pointer + 1;
  }

  @return $pointer, if($minus and $result != null, $result * -1, $result);
}

// JSON.parse a string
@function _json-decode--string($source, $pointer) {
  // Check for the end of the string
  $temp: str-slice($source, $pointer);
  $end: str-index($temp, '"');
  $string: "";

  // If no end is found
  @if $end == 0 {
    @return _throw("Unterminated string.", $pointer);
  }
  
  @else if $end > 1 {
    $string: str-slice($temp, 1, $end - 1); 
    $string: _strip-special-char($string, "\r");
    $string: _strip-special-char($string, "\n");
  }

  @return ($pointer + $end, $string);
}
// JSON.parse a true bool
@function _json-decode--true($source, $pointer) {
  $length: str-length($source);
  @if $length - $pointer < 2
  or str-slice($source, $pointer, $pointer) != 'r'
  or str-slice($source, $pointer + 1, $pointer + 1) != 'u'
  or str-slice($source, $pointer + 2, $pointer + 2) != 'e' {
    @return _throw("Unexpected token: `t`.", $pointer);
  }
  @return ($pointer + 3, true);
}

// JSON.parse a false bool
@function _json-decode--false($source, $pointer) {
  $length: str-length($source);
  @if $length - $pointer < 3
  or str-slice($source, $pointer, $pointer) != 'a'
  or str-slice($source, $pointer + 1, $pointer + 1) != 'l'
  or str-slice($source, $pointer + 2, $pointer + 2) != 's'
  or str-slice($source, $pointer + 3, $pointer + 3) != 'e' {
    @return _throw("Unexpected token: `f`.", $pointer);
  }
  @return ($pointer + 4, false);
}

// JSON.parse a null value
@function _json-decode--null($source, $pointer) {
  $length: str-length($source);
  @if $length - $pointer < 2
  or str-slice($source, $pointer, $pointer) != 'u'
  or str-slice($source, $pointer + 1, $pointer + 1) != 'l'
  or str-slice($source, $pointer + 2, $pointer + 2) != 'l' {
    @return _throw("Unexpected token: `n`.", $pointer);
  }
  @return ($pointer + 3, null);
}

// JSON.parse a number
@function _json-decode--number($source, $pointer) {
  $pointer: $pointer - 1; // Move back pointer to begininng of number
  $allowed: '-' '0' '1' '2' '3' '4' '5' '6' '7' '8' '9'; // Allowed characted to start with
  $first: str-slice($source, $pointer, $pointer); // First character of the number
  $minus: $first == '-'; // Is it negative?

  // Early check for errors
  @if not index($allowed, $first) {
    @return _throw("Unexpected token `" + $first + "`.", $pointer);
  }

  // Find the integer part
  $find-integer: _find-integer($source, $pointer);
  $pointer: nth($find-integer, 1);
  $result:  nth($find-integer, 2);
  @if not $result { // Error occured
    @return $find-integer;
  }

  // Find digits
  @if str-slice($source, $pointer, $pointer) == '.' {
    $find-digits: _find-digits($source, $pointer);
    $pointer: nth($find-digits, 1);
    $digits:  nth($find-digits, 2);

    @if $digits == null { // Empty digits, throw error
      @return _throw("Unexpected end of input.", $pointer);
    }
    @else if $digits == false { // Error occured, return it
      @return $find-digits;
    }

    $result: $result + $digits;
  }

  // Find exponent
  @if to-lower-case(str-slice($source, $pointer, $pointer)) == 'e' {
    $find-exponent: _find-exponent($source, $pointer);
    $pointer:  nth($find-exponent, 1);
    $exponent: nth($find-exponent, 2);

    @if $exponent == null { // Empty exponent, throw error
      @return _throw("Unexpected end of input.", $pointer);
    }
    @else if $exponent == false { // Error occured, return it
      @return $find-exponent;
    }

    $result: $result * _pow(10, $exponent);
  }

  @return ($pointer, if($minus, $result * -1, $result));
}

// JSON.parse a an array to a list
@function _json-decode--list($source, $pointer) {
  $length: str-length($source);
  $list: ();
  $needs-comma: false;

  @if $pointer <= $length and str-slice($source, $pointer, $pointer) == "]" {
    @return ($pointer + 1, $list);
  }

  @while $pointer <= $length {
    $char: str-slice($source, $pointer, $pointer);

    @if $char == "]" {
      @if not $needs-comma {
        @return _throw("Unexpected comma in array literal.", $pointer);
      }

      // Do it the Sass way and destruct a single item array to an element.
      @return ($pointer + 1, if(length($list) == 1, nth($list, 1), $list));
    }
    @else if $char == " " {
      $pointer: $pointer + 1;
    }
    @else if $char == "," {
      @if not $needs-comma {
        @return _throw("Unexpected comma in array literal.", $pointer);
      }
      $needs-comma: false;
      $pointer: $pointer + 1;
    }
    @else {
      @if $needs-comma {
        @return _throw("Missing comma in array literal.", $pointer);
      }
      $read: _json-decode--value($source, $pointer);
      $pointer: nth($read, 1);
      $list: append($list, nth($read, 2));
      $needs-comma: true;
    }
  }

  @return _throw("Unterminated array literal.", $pointer);
}

// JSON.parse an object to a map
@function _json-decode--map($source, $pointer) {
  $length: str-length($source);
  $map: ();
  $needs-comma: false;

  // Deal with empty map
  @if $pointer <= $length and str-slice($source, $pointer, $pointer) == "}" {
    @return ($pointer + 1, $map);
  }

  @while $pointer <= $length {
    $char: str-slice($source, $pointer, $pointer);
    $pointer: $pointer + 1;

    @if $char == "}" {
      @if not $needs-comma and length($map) != 0 {
        @return _throw("Unexpected comma in object literal.", $pointer);
      }
      @return ($pointer + 1, $map);
    }

    @else if $char == " " {
      // @continue;
    }

    @else if $char == "," {
      @if not $needs-comma {
        @return _throw("Unexpected comma in object literal.", $pointer);
      }
      $needs-comma: false;
    }

    @else if $char == '"' {
      @if $needs-comma {
        @return _throw("Missing comma in object literal.", $pointer);
      }

      // Read key
      $read-key:  _json-decode--string($source, $pointer);
      $pointer: nth($read-key, 1);
      $key:      nth($read-key, 2);

      // Remove colon
      $pointer: _consume($source, $pointer, ":");
      @if length($pointer) > 1 { // If consume has failed
        @return _throw("Consuming token `:` failed.", 0); 
      } 

      // Read value
      $read-value: _json-decode--value($source, $pointer);
      $pointer: nth($read-value, 1);
      $value:    nth($read-value, 2);

      // Add pair to map
      $map: map-merge($map, ($key: $value));
      $needs-comma: true;
    }

    @else {
      @return _throw("Unexpected token in object literal.", $pointer);
    }
  }

  @return _throw("Unterminated object literal.", $pointer);
}

// JSON.parse a string
// @param $json: json string to parse
// @return literal
@function json-decode($json) {
  $value: null;
  $pointer: 1;
  $length: str-length($json);

  @if $json == null {
    @return _throw("Input string may not be null", $pointer);
  }

  @while $value != false // Stop if error
  and $pointer <= $length {
    $read: _json-decode--value($json, $pointer);
    $pointer: nth($read, 1);
    $value: nth($read, 2);
  }

  @return $value;
}

// Proof quote a value
// @param $value: value to be quoted
// @return [string]
@function _proof-quote($value) {
  @return '"' + $value + '"';
}

// JSON.stringify a bool
// @param $bool: bool to be stringified
// @return [bool]
@function _json-encode--bool($boolean) {
  @return $boolean;
}

// JSON.stringify a color
// @param $color: color to be stringified
// @return [color]
@function _json-encode--color($color) {
  @return _proof-quote($color);
}

// JSON.stringify a list
// @param $list: list to be stringified
// @return [list]
@function _json-encode--list($list) {
  $str: "";
  @each $item in $list {
    $str: $str + ', ' + json-encode($item);
  }
  @return '[' + str-slice($str, 3) + ']';
}

// JSON.stringify a map
// @param $map: map to be stringified
// @return [map]
@function _json-encode--map($map) {
  $str: "";
  @each $key, $value in $map {
    $str: $str + ', ' + _proof-quote($key) + ': ' + json-encode($value);
  }
  @return '{' + str-slice($str, 3) + '}';
}

// JSON.stringify a number
// @param $number: number to be stringified
// @return [number]
@function _json-encode--number($number) {
  @return $number;
}

// JSON.stringify a string
// @param $string: string to be stringified
// @return [string]
@function _json-encode--string($string) {
  @return _proof-quote($string);
}

// JSON.stringify a null
// @param $null: a sass null to be stringified
// @return [string] with content null
@function _json-encode--null($null) {
  @return "null";
}

// JSON.stringify a value and pass it as a font-family of head element
// @param $value: value to be stringified
@mixin json-encode($value) {
  head {
    font-family: json-encode($value);
  }
}

// JSON.stringify a value
// @param $value: value to be stringified
// @return [string |  false]
@function json-encode($value) {
  $types: list, map, number, string, bool, color;
  $value-type: type-of($value);
  @if $value-type != null or index($types, $value-type) {
    @return call('_json-encode--#{$value-type}', $value);
  }
  @warn "Unknown type for #{$value}.";
  @return false;
}
